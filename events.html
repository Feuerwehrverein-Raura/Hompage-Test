<!DOCTYPE html>
<html lang="de" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Veranstaltungen - Feuerwehrverein Raura Kaiseraugst</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        fire: {
                            50: '#fef2f2',
                            100: '#fee2e2',
                            200: '#fecaca',
                            300: '#fca5a5',
                            400: '#f87171',
                            500: '#ef4444',
                            600: '#dc2626',
                            700: '#b91c1c',
                            800: '#991b1b',
                            900: '#7f1d1d'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="font-sans antialiased bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-fire-700 text-white shadow-lg">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 rounded-full overflow-hidden border-2 border-fire-300 shadow-lg bg-white">
                        <img src="images/logo.png" alt="Feuerwehrverein Raura Logo" class="w-full h-full object-contain p-1">
                    </div>
                    <div>
                        <h1 class="text-xl font-bold">Feuerwehrverein Raura</h1>
                        <p class="text-fire-200 text-sm">Kaiseraugst</p>
                    </div>
                </div>
                <div class="flex space-x-6">
                    <a href="index.html" class="hover:text-fire-200 transition-colors">Home</a>
                    <a href="calendar.html" class="hover:text-fire-200 transition-colors">Kalender</a>
                    <a href="events.html" class="text-fire-200 font-semibold">Veranstaltungen</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Header -->
    <section class="bg-gradient-to-r from-fire-600 to-fire-700 text-white py-12">
        <div class="container mx-auto px-4 text-center">
            <h2 class="text-4xl font-bold mb-4">Unsere Veranstaltungen</h2>
            <p class="text-fire-100 text-lg mb-6">Detaillierte Informationen zu allen Terminen und Events</p>
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <button id="filter-all" class="filter-btn active bg-white text-fire-700 px-6 py-3 rounded-lg font-semibold hover:bg-fire-50 transition-colors" data-filter="all">
                    Alle Veranstaltungen
                </button>
                <button id="filter-upcoming" class="filter-btn border-2 border-white text-white px-6 py-3 rounded-lg font-semibold hover:bg-white hover:text-fire-700 transition-colors" data-filter="upcoming">
                    Kommende
                </button>
                <button id="filter-past" class="filter-btn border-2 border-white text-white px-6 py-3 rounded-lg font-semibold hover:bg-white hover:text-fire-700 transition-colors" data-filter="past">
                    Vergangene
                </button>
            </div>
        </div>
    </section>

    <!-- Filters and Search -->
    <section class="bg-white shadow-sm py-6">
        <div class="container mx-auto px-4">
            <div class="flex flex-col lg:flex-row justify-between items-center space-y-4 lg:space-y-0">
                <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                    <div class="relative">
                        <input type="text" id="search-input" placeholder="Veranstaltungen suchen..." 
                               class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fire-500 w-full sm:w-64">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <span class="text-gray-400">ğŸ”</span>
                        </div>
                    </div>
                    <select id="category-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fire-500">
                        <option value="">Alle Kategorien</option>
                        <option value="Hauptveranstaltung">Hauptveranstaltung</option>
                        <option value="Gesellschaftsanlass">Gesellschaftsanlass</option>
                        <option value="Ausflug">Ausflug</option>
                        <option value="Vereinsintern">Vereinsintern</option>
                    </select>
                </div>
                <div class="flex space-x-2">
                    <button id="list-view-btn" class="p-2 bg-fire-500 text-white rounded-lg hover:bg-fire-600 transition-colors">
                        <span class="text-xl">ğŸ“‹</span>
                    </button>
                    <button id="grid-view-btn" class="p-2 border border-gray-300 text-gray-600 rounded-lg hover:bg-gray-50 transition-colors">
                        <span class="text-xl">âŠ</span>
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Events List -->
    <section class="py-8">
        <div class="container mx-auto px-4">
            <div id="events-container" class="space-y-6">
                <!-- Events will be loaded here -->
            </div>
            
            <!-- No events message -->
            <div id="no-events" class="hidden text-center py-12">
                <div class="text-gray-400 text-6xl mb-4">ğŸ“…</div>
                <h3 class="text-xl font-semibold text-gray-600 mb-2">Keine Veranstaltungen gefunden</h3>
                <p class="text-gray-500">Versuchen Sie andere Suchkriterien oder Filter.</p>
            </div>
        </div>
    </section>

    <!-- Event Detail Modal -->
    <div id="event-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="relative">
                <!-- Modal Header -->
                <div id="modal-header" class="bg-gradient-to-r from-fire-500 to-fire-600 text-white p-6 rounded-t-lg">
                    <button id="close-modal" class="absolute top-4 right-4 text-white hover:text-fire-200 text-2xl">Ã—</button>
                    <h2 id="modal-title" class="text-2xl font-bold mb-2"></h2>
                    <div id="modal-meta" class="flex flex-wrap gap-4 text-fire-100 text-sm"></div>
                </div>
                
                <!-- Modal Content -->
                <div class="p-6">
                    <div id="modal-content" class="prose max-w-none">
                        <!-- Event details will be loaded here -->
                    </div>
                    
                    <!-- Registration Section -->
                    <div id="registration-section" class="hidden mt-8 border-t pt-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ“§ Anmeldung</h3>
                        
                        <!-- Shift Selection -->
                        <div id="shift-selection" class="hidden mb-6">
                            <h4 class="font-semibold text-gray-700 mb-3">VerfÃ¼gbare Schichten:</h4>
                            <div id="shifts-container" class="space-y-2">
                                <!-- Shifts will be populated by JavaScript -->
                            </div>
                        </div>

                        <!-- Personal Information -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Name *</label>
                                <input type="text" id="reg-name" placeholder="Ihr Name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fire-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">E-Mail *</label>
                                <input type="email" id="reg-email" placeholder="ihre@email.ch" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fire-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Telefon</label>
                                <input type="tel" id="reg-phone" placeholder="079 123 45 67" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fire-500">
                            </div>
                            <div id="participants-section" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Anzahl Personen</label>
                                <select id="reg-participants" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fire-500">
                                    <option value="1">1 Person</option>
                                    <option value="2">2 Personen</option>
                                    <option value="3">3 Personen</option>
                                    <option value="4">4 Personen</option>
                                    <option value="5">5+ Personen</option>
                                </select>
                            </div>
                        </div>

                        <!-- Additional Notes -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Bemerkungen</label>
                            <textarea id="reg-notes" rows="3" placeholder="Besondere WÃ¼nsche, Allergien, etc." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fire-500"></textarea>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3">
                            <button id="send-registration-email" class="flex-1 bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition-colors flex items-center justify-center space-x-2">
                                <span>ğŸ“§</span>
                                <span>Anmeldung per E-Mail senden</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Regular Modal Actions -->
                    <div class="mt-6 flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3">
                        <button id="download-event-ics" class="flex-1 bg-fire-500 text-white px-4 py-3 rounded-lg hover:bg-fire-600 transition-colors flex items-center justify-center space-x-2">
                            <span>â¬‡ï¸</span>
                            <span>ICS herunterladen</span>
                        </button>
                        <button id="share-event" class="flex-1 border border-fire-500 text-fire-500 px-4 py-3 rounded-lg hover:bg-fire-50 transition-colors flex items-center justify-center space-x-2">
                            <span>ğŸ“¤</span>
                            <span>Teilen</span>
                        </button>
                        <button id="close-modal-btn" class="flex-1 border border-gray-300 text-gray-700 px-4 py-3 rounded-lg hover:bg-gray-50 transition-colors">
                            SchlieÃŸen
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loading" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-40">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-fire-500 mx-auto mb-4"></div>
            <p class="text-gray-600">Lade Veranstaltungen...</p>
        </div>
    </div>

    <script>
        class EventsManager {
            constructor() {
                this.events = [];
                this.filteredEvents = [];
                this.currentFilter = 'all';
                this.currentCategory = '';
                this.searchQuery = '';
                this.viewMode = 'list';
                this.selectedEvent = null;
                this.selectedShifts = [];
                
                this.init();
            }

            async init() {
                console.log('ğŸ”„ Initialisiere Event-System...');
                await this.loadEvents();
                this.setupEventListeners();
                this.filterEvents();
                this.renderEvents();
                document.getElementById('loading').classList.add('hidden');
            }

            async loadEvents() {
                try {
                    console.log('ğŸ“‚ Lade Events aus Markdown-Dateien...');
                    this.events = await this.loadEventsFromMarkdown();
                    console.log(`âœ… ${this.events.length} Events erfolgreich geladen:`, 
                        this.events.map(e => `${e.title} (${e.id})`));
                } catch (error) {
                    console.error('âŒ Fehler beim Laden der Veranstaltungen:', error);
                    this.events = await this.getFallbackEvents();
                }
            }

            async loadEventsFromMarkdown() {
                // Liste aller Event-Dateien (manuell gepflegt oder dynamisch erweitert)
                const eventFiles = [
                    'events/chilbi-2024.md',
                    'events/chilbi-2025.md',
                    'events/grillplausch-sommer-2024.md',
                    // Weitere Event-Dateien hier hinzufÃ¼gen
                ];

                const promises = eventFiles.map(async (file) => {
                    try {
                        console.log(`ğŸ“„ Lade: ${file}`);
                        const response = await fetch(file);
                        
                        if (!response.ok) {
                            console.warn(`âš ï¸ ${file}: HTTP ${response.status}`);
                            return null;
                        }
                        
                        const content = await response.text();
                        
                        if (!content.trim()) {
                            console.warn(`âš ï¸ ${file}: Datei ist leer`);
                            return null;
                        }
                        
                        const event = this.parseMarkdownEvent(content, file);
                        if (event) {
                            console.log(`âœ… Parsed: ${event.title}`);
                            return event;
                        }
                        
                    } catch (error) {
                        console.error(`âŒ Fehler beim Laden von ${file}:`, error);
                        return null;
                    }
                });

                const results = await Promise.allSettled(promises);
                return results
                    .filter(result => result.status === 'fulfilled' && result.value !== null)
                    .map(result => result.value)
                    .sort((a, b) => a.startDate - b.startDate);
            }

            parseMarkdownEvent(content, filename = '') {
                try {
                    // Frontmatter pattern matching
                    const frontmatterMatch = content.match(/^---\r?\n([\s\S]*?)\r?\n---\r?\n([\s\S]*)$/);
                    
                    if (!frontmatterMatch) {
                        console.warn(`âš ï¸ ${filename}: Kein Frontmatter gefunden`);
                        return null;
                    }

                    const [, frontmatterStr, markdownContent] = frontmatterMatch;
                    const frontmatter = this.parseFrontmatter(frontmatterStr);
                    
                    // Pflichtfelder validieren
                    if (!frontmatter.id || !frontmatter.title || !frontmatter.startDate || !frontmatter.endDate) {
                        console.warn(`âš ï¸ ${filename}: Pflichtfelder fehlen`);
                        return null;
                    }
                    
                    return {
                        ...frontmatter,
                        description: this.parseMarkdownDescription(markdownContent.trim()),
                        startDate: new Date(frontmatter.startDate),
                        endDate: new Date(frontmatter.endDate),
                        registrationDeadline: frontmatter.registrationDeadline ? 
                            new Date(frontmatter.registrationDeadline) : null,
                        _source: filename
                    };
                    
                } catch (error) {
                    console.error(`âŒ ${filename}: Parse-Fehler:`, error);
                    return null;
                }
            }

            parseFrontmatter(frontmatterStr) {
                const result = {};
                const lines = frontmatterStr.split(/\r?\n/).filter(line => line.trim());
                
                let currentKey = null;
                let currentValue = '';
                let inArrayOrObject = false;
                let arrayDepth = 0;
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    
                    // Skip comments
                    if (line.trim().startsWith('#')) continue;
                    
                    // Handle array/object continuation
                    if (inArrayOrObject) {
                        currentValue += '\n' + line;
                        
                        // Count array depth
                        arrayDepth += (line.match(/- /g) || []).length;
                        
                        // Check if array/object is complete
                        const nextLine = lines[i + 1];
                        if (!nextLine || (!nextLine.startsWith(' ') && !nextLine.startsWith('-') && nextLine.includes(':'))) {
                            // Process the complete value
                            result[currentKey] = this.parseComplexValue(currentValue);
                            inArrayOrObject = false;
                            currentKey = null;
                            currentValue = '';
                            arrayDepth = 0;
                        }
                        continue;
                    }
                    
                    const colonIndex = line.indexOf(':');
                    if (colonIndex === -1) continue;
                    
                    const key = line.substring(0, colonIndex).trim();
                    let value = line.substring(colonIndex + 1).trim();
                    
                    if (!key) continue;
                    
                    // Handle multiline values (arrays, objects)
                    if (!value || value === '|' || value === '>') {
                        currentKey = key;
                        currentValue = value;
                        inArrayOrObject = true;
                        continue;
                    }
                    
                    // Parse simple values
                    result[key] = this.parseSimpleValue(value);
                }
                
                return result;
            }

            parseComplexValue(value) {
                try {
                    // Handle shifts array - improved parsing
                    if (value.includes('- id:')) {
                        console.log('ğŸ”„ Parse shifts array...');
                        const shifts = [];
                        
                        // Split by shift entries but keep the delimiter
                        const shiftEntries = value.split(/(?=\s*- id:)/g).filter(entry => entry.trim());
                        
                        for (const entry of shiftEntries) {
                            const shift = {};
                            const lines = entry.split('\n');
                            
                            for (const line of lines) {
                                const trimmed = line.trim();
                                if (!trimmed || trimmed.startsWith('#')) continue;
                                
                                const colonIndex = trimmed.indexOf(':');
                                if (colonIndex === -1) continue;
                                
                                const key = trimmed.substring(0, colonIndex).replace(/^-\s*/, '').trim();
                                let shiftValue = trimmed.substring(colonIndex + 1).trim();
                                
                                // Remove quotes if present
                                if ((shiftValue.startsWith('"') && shiftValue.endsWith('"')) || 
                                    (shiftValue.startsWith("'") && shiftValue.endsWith("'"))) {
                                    shiftValue = shiftValue.slice(1, -1);
                                }
                                
                                switch(key) {
                                    case 'id':
                                        shift.id = shiftValue;
                                        break;
                                    case 'name':
                                        shift.name = shiftValue;
                                        break;
                                    case 'date':
                                        shift.date = shiftValue;
                                        break;
                                    case 'time':
                                        shift.time = shiftValue;
                                        break;
                                    case 'needed':
                                        shift.needed = parseInt(shiftValue) || 1;
                                        break;
                                    case 'description':
                                        shift.description = shiftValue;
                                        break;
                                }
                            }
                            
                            if (shift.id && shift.name) {
                                shifts.push(shift);
                                console.log(`âœ… Parsed shift: ${shift.name} (${shift.id})`);
                            }
                        }
                        
                        console.log(`ğŸ“Š Total shifts parsed: ${shifts.length}`);
                        return shifts;
                    }
                    
                    // Handle simple arrays
                    if (value.includes('[') && value.includes(']')) {
                        const match = value.match(/\[(.*)\]/);
                        if (match) {
                            return match[1].split(',').map(s => s.trim().replace(/['"]/g, ''));
                        }
                    }
                    
                    return value.trim();
                } catch (error) {
                    console.error('âŒ Fehler beim Parsen von komplexem Wert:', error, 'Value:', value);
                    return value;
                }
            }

            parseSimpleValue(value) {
                // Remove quotes
                if ((value.startsWith('"') && value.endsWith('"')) || 
                    (value.startsWith("'") && value.endsWith("'"))) {
                    value = value.slice(1, -1);
                }
                
                // Parse booleans
                if (value === 'true') return true;
                if (value === 'false') return false;
                
                // Parse numbers
                if (!isNaN(value) && value !== '' && !isNaN(parseFloat(value))) {
                    return parseFloat(value);
                }
                
                // Parse arrays
                if (value.startsWith('[') && value.endsWith(']')) {
                    const arrayContent = value.slice(1, -1);
                    return arrayContent.split(',').map(s => s.trim().replace(/['"]/g, ''));
                }
                
                return value;
            }

            parseMarkdownDescription(markdown) {
                // Simple markdown to plain text conversion for preview
                return markdown
                    .replace(/^#{1,6}\s+/gm, '') // Remove headers
                    .replace(/\*\*(.*?)\*\*/g, '$1') // Remove bold
                    .replace(/\*(.*?)\*/g, '$1') // Remove italic
                    .replace(/- /g, 'â€¢ ') // Convert lists
                    .replace(/\n\n+/g, '\n\n') // Normalize newlines
                    .substring(0, 300); // Limit length for preview
            }

            async getFallbackEvents() {
                // Fallback events wenn Markdown-Dateien nicht geladen werden kÃ¶nnen
                console.log('âš ï¸ Verwende Fallback-Events');
                return [
                    {
                        id: 'chilbi-fallback',
                        title: 'Chilbi 2025',
                        subtitle: 'Traditionelle Dorfchilbi',
                        description: 'Unsere traditionelle Chilbi im Roten Schopf. Details werden geladen...',
                        startDate: new Date(2025, 9, 18, 12, 0),
                        endDate: new Date(2025, 9, 19, 22, 0),
                        location: 'Roter Schopf, Kaiseraugst',
                        category: 'Hauptveranstaltung',
                        organizer: 'Stefan MÃ¼ller',
                        email: 'aktuar@fwv-raura.ch',
                        status: 'confirmed',
                        registrationRequired: true,
                        cost: 'Kostenlos',
                        tags: ['Chilbi', 'Familie', 'Helfer']
                    }
                ];
            }

            setupEventListeners() {
                // Filter buttons
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.currentFilter = e.target.dataset.filter;
                        this.updateFilterButtons();
                        this.filterEvents();
                        this.renderEvents();
                    });
                });

                // Search and filters
                document.getElementById('search-input').addEventListener('input', (e) => {
                    this.searchQuery = e.target.value.toLowerCase();
                    this.filterEvents();
                    this.renderEvents();
                });

                document.getElementById('category-filter').addEventListener('change', (e) => {
                    this.currentCategory = e.target.value;
                    this.filterEvents();
                    this.renderEvents();
                });

                // View mode buttons
                document.getElementById('list-view-btn').addEventListener('click', () => {
                    this.viewMode = 'list';
                    this.updateViewButtons();
                    this.renderEvents();
                });

                document.getElementById('grid-view-btn').addEventListener('click', () => {
                    this.viewMode = 'grid';
                    this.updateViewButtons();
                    this.renderEvents();
                });

                // Modal controls
                document.getElementById('close-modal').addEventListener('click', () => this.closeModal());
                document.getElementById('close-modal-btn').addEventListener('click', () => this.closeModal());
                document.getElementById('download-event-ics').addEventListener('click', () => this.downloadEventICS());
                document.getElementById('share-event').addEventListener('click', () => this.shareEvent());
                
                // Registration
                document.getElementById('send-registration-email').addEventListener('click', () => this.sendRegistrationEmail());
                
                document.getElementById('event-modal').addEventListener('click', (e) => {
                    if (e.target.id === 'event-modal') this.closeModal();
                });
            }

            updateFilterButtons() {
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    const isActive = btn.dataset.filter === this.currentFilter;
                    btn.className = isActive 
                        ? 'filter-btn active bg-white text-fire-700 px-6 py-3 rounded-lg font-semibold hover:bg-fire-50 transition-colors'
                        : 'filter-btn border-2 border-white text-white px-6 py-3 rounded-lg font-semibold hover:bg-white hover:text-fire-700 transition-colors';
                });
            }

            updateViewButtons() {
                const listBtn = document.getElementById('list-view-btn');
                const gridBtn = document.getElementById('grid-view-btn');
                
                if (this.viewMode === 'list') {
                    listBtn.className = 'p-2 bg-fire-500 text-white rounded-lg hover:bg-fire-600 transition-colors';
                    gridBtn.className = 'p-2 border border-gray-300 text-gray-600 rounded-lg hover:bg-gray-50 transition-colors';
                } else {
                    listBtn.className = 'p-2 border border-gray-300 text-gray-600 rounded-lg hover:bg-gray-50 transition-colors';
                    gridBtn.className = 'p-2 bg-fire-500 text-white rounded-lg hover:bg-fire-600 transition-colors';
                }
            }

            filterEvents() {
                const now = new Date();
                let filtered = [...this.events];

                // Time filter
                if (this.currentFilter === 'upcoming') {
                    filtered = filtered.filter(event => event.startDate > now);
                } else if (this.currentFilter === 'past') {
                    filtered = filtered.filter(event => event.endDate < now);
                }

                // Category filter
                if (this.currentCategory) {
                    filtered = filtered.filter(event => event.category === this.currentCategory);
                }

                // Search filter
                if (this.searchQuery) {
                    filtered = filtered.filter(event => 
                        event.title.toLowerCase().includes(this.searchQuery) ||
                        event.description.toLowerCase().includes(this.searchQuery) ||
                        event.location.toLowerCase().includes(this.searchQuery) ||
                        event.organizer.toLowerCase().includes(this.searchQuery) ||
                        (event.tags && event.tags.some(tag => tag.toLowerCase().includes(this.searchQuery)))
                    );
                }

                // Sort by date
                filtered.sort((a, b) => {
                    if (this.currentFilter === 'past') {
                        return b.startDate - a.startDate;
                    }
                    return a.startDate - b.startDate;
                });

                this.filteredEvents = filtered;
            }

            renderEvents() {
                const container = document.getElementById('events-container');
                const noEventsMsg = document.getElementById('no-events');

                if (this.filteredEvents.length === 0) {
                    container.innerHTML = '';
                    noEventsMsg.classList.remove('hidden');
                    return;
                }

                noEventsMsg.classList.add('hidden');

                if (this.viewMode === 'list') {
                    container.className = 'space-y-6';
                    container.innerHTML = this.filteredEvents.map(event => this.createEventListItem(event)).join('');
                } else {
                    container.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
                    container.innerHTML = this.filteredEvents.map(event => this.createEventGridItem(event)).join('');
                }

                // Add click listeners
                container.querySelectorAll('[data-event-id]').forEach(el => {
                    el.addEventListener('click', (e) => {
                        const eventId = e.currentTarget.dataset.eventId;
                        this.showEventModal(eventId);
                    });
                });
            }

            createEventListItem(event) {
                const isPast = event.endDate < new Date();
                const statusBadge = this.getStatusBadge(event);
                const registrationBadge = this.getRegistrationBadge(event);
                
                return `
                    <div class="bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow cursor-pointer overflow-hidden ${isPast ? 'opacity-75' : ''}" 
                         data-event-id="${event.id}">
                        <div class="p-6">
                            <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between">
                                <div class="flex-1">
                                    <div class="flex items-start justify-between mb-3">
                                        <div>
                                            <h3 class="text-xl font-bold text-gray-800 mb-1">${event.title}</h3>
                                            <p class="text-fire-600 font-medium">${event.subtitle || ''}</p>
                                        </div>
                                        <div class="flex space-x-2">
                                            ${statusBadge}
                                            ${registrationBadge}
                                        </div>
                                    </div>
                                    
                                    <div class="prose prose-sm max-w-none mb-4 text-gray-600">
                                        ${this.truncateText(event.description, 200)}
                                    </div>
                                    
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm text-gray-500 mb-4">
                                        <div class="space-y-2">
                                            <div class="flex items-center">
                                                <span class="mr-2">ğŸ“…</span>
                                                <span>${this.formatDate(event.startDate)}</span>
                                            </div>
                                            <div class="flex items-center">
                                                <span class="mr-2">â°</span>
                                                <span>${this.formatTime(event.startDate)} - ${this.formatTime(event.endDate)}</span>
                                            </div>
                                        </div>
                                        <div class="space-y-2">
                                            <div class="flex items-center">
                                                <span class="mr-2">ğŸ“</span>
                                                <span>${event.location}</span>
                                            </div>
                                            <div class="flex items-center">
                                                <span class="mr-2">ğŸ‘¤</span>
                                                <span>${event.organizer}</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="flex flex-wrap gap-2">
                                        ${(event.tags || []).map(tag => `
                                            <span class="px-2 py-1 bg-gray-100 text-gray-600 rounded-full text-xs">
                                                ${tag}
                                            </span>
                                        `).join('')}
                                    </div>
                                </div>
                                
                                <div class="mt-4 lg:mt-0 lg:ml-6 flex-shrink-0">
                                    <span class="inline-block px-3 py-1 bg-fire-100 text-fire-800 rounded-full text-sm font-medium">
                                        ${event.category || 'Event'}
                                    </span>
                                    ${event.cost && event.cost !== 'Kostenlos' ? `
                                        <div class="mt-2 text-lg font-bold text-fire-600">
                                            ${event.cost}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            createEventGridItem(event) {
                const isPast = event.endDate < new Date();
                const statusBadge = this.getStatusBadge(event);
                const registrationBadge = this.getRegistrationBadge(event);
                
                return `
                    <div class="bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow cursor-pointer overflow-hidden ${isPast ? 'opacity-75' : ''}" 
                         data-event-id="${event.id}">
                        <div class="p-6">
                            <div class="flex justify-between items-start mb-3">
                                <h3 class="text-lg font-bold text-gray-800 leading-tight">${event.title}</h3>
                                <div class="flex flex-col space-y-1">
                                    ${statusBadge}
                                    ${registrationBadge}
                                </div>
                            </div>
                            
                            <p class="text-fire-600 text-sm font-medium mb-3">${event.subtitle || ''}</p>
                            
                            <div class="text-sm text-gray-600 mb-4">
                                ${this.truncateText(event.description, 120)}
                            </div>
                            
                            <div class="space-y-2 text-sm text-gray-500 mb-4">
                                <div class="flex items-center">
                                    <span class="mr-2">ğŸ“…</span>
                                    <span>${this.formatDate(event.startDate)}</span>
                                </div>
                                <div class="flex items-center">
                                    <span class="mr-2">ğŸ“</span>
                                    <span class="truncate">${event.location}</span>
                                </div>
                            </div>
                            
                            <div class="flex justify-between items-center">
                                <span class="px-2 py-1 bg-fire-100 text-fire-800 rounded-full text-xs font-medium">
                                    ${event.category || 'Event'}
                                </span>
                                ${event.cost && event.cost !== 'Kostenlos' ? `
                                    <span class="text-fire-600 font-bold text-sm">${event.cost}</span>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }

            getStatusBadge(event) {
                const now = new Date();
                
                if (event.endDate < now) {
                    return '<span class="px-2 py-1 bg-gray-100 text-gray-600 rounded-full text-xs font-medium">Vergangen</span>';
                } else if (event.startDate <= now && event.endDate >= now) {
                    return '<span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium animate-pulse">LÃ¤uft</span>';
                } else if (event.registrationRequired && event.registrationDeadline && event.registrationDeadline < now) {
                    return '<span class="px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs font-medium">Anmeldung geschlossen</span>';
                } else {
                    return '<span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-medium">Geplant</span>';
                }
            }

            getRegistrationBadge(event) {
                if (!event.registrationRequired) return '';
                
                const now = new Date();
                if (event.registrationDeadline && event.registrationDeadline < now) return '';
                if (event.endDate < now) return '';
                
                if (event.shifts && event.shifts.length > 0) {
                    return '<span class="px-2 py-1 bg-orange-100 text-orange-800 rounded-full text-xs font-medium">ğŸ‘· Helfer gesucht</span>';
                } else if (event.participantRegistration) {
                    return '<span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium">ğŸ“§ Anmeldung mÃ¶glich</span>';
                }
                
                return '';
            }

            showEventModal(eventId) {
                const event = this.events.find(e => e.id === eventId);
                if (!event) return;

                this.selectedEvent = event;
                this.selectedShifts = [];
                
                document.getElementById('modal-title').textContent = event.title;
                document.getElementById('modal-meta').innerHTML = `
                    <span>ğŸ“… ${this.formatDate(event.startDate)}</span>
                    <span>â° ${this.formatTime(event.startDate)} - ${this.formatTime(event.endDate)}</span>
                    <span>ğŸ“ ${event.location}</span>
                    <span>ğŸ‘¤ ${event.organizer}</span>
                `;

                document.getElementById('modal-content').innerHTML = `
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">${event.subtitle || ''}</h3>
                        <div class="prose max-w-none">
                            ${this.parseMarkdownToHTML(event.description)}
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="space-y-3">
                            <h4 class="font-semibold text-gray-800">Veranstaltungsdetails</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Kategorie:</span>
                                    <span class="px-2 py-1 bg-fire-100 text-fire-800 rounded text-xs">${event.category || 'Event'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Kosten:</span>
                                    <span class="font-medium">${event.cost || 'Nicht angegeben'}</span>
                                </div>
                                ${event.registrationRequired ? `
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Anmeldung:</span>
                                        <span class="text-fire-600">Erforderlich</span>
                                    </div>
                                ` : ''}
                                ${event.registrationDeadline ? `
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Anmeldeschluss:</span>
                                        <span>${this.formatDate(event.registrationDeadline)}</span>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div class="space-y-3">
                            <h4 class="font-semibold text-gray-800">Kontakt</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Organisator:</span>
                                    <span class="font-medium">${event.organizer}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">E-Mail:</span>
                                    <a href="mailto:${event.email}" class="text-fire-600 hover:text-fire-700">${event.email}</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    ${(event.tags && event.tags.length > 0) ? `
                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-800 mb-2">Tags</h4>
                            <div class="flex flex-wrap gap-2">
                                ${event.tags.map(tag => `
                                    <span class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm">
                                        ${tag}
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                `;

                // Show registration section if applicable
                this.setupRegistrationSection(event);
                
                document.getElementById('event-modal').classList.remove('hidden');
            }

            setupRegistrationSection(event) {
                const registrationSection = document.getElementById('registration-section');
                const shiftSelection = document.getElementById('shift-selection');
                const shiftsContainer = document.getElementById('shifts-container');
                const participantsSection = document.getElementById('participants-section');

                console.log('ğŸ”„ Setup Registration fÃ¼r Event:', event.title);
                console.log('ğŸ“‹ Event shifts:', event.shifts);

                // Check if registration is possible
                const now = new Date();
                const canRegister = event.registrationRequired && 
                    (!event.registrationDeadline || event.registrationDeadline > now) &&
                    event.endDate > now;

                if (!canRegister) {
                    console.log('âŒ Anmeldung nicht mÃ¶glich fÃ¼r:', event.title);
                    registrationSection.classList.add('hidden');
                    return;
                }

                registrationSection.classList.remove('hidden');

                // Setup shifts if available
                if (event.shifts && Array.isArray(event.shifts) && event.shifts.length > 0) {
                    console.log(`âœ… ${event.shifts.length} Schichten gefunden, zeige Schichtauswahl`);
                    shiftSelection.classList.remove('hidden');
                    participantsSection.classList.add('hidden');
                    
                    shiftsContainer.innerHTML = event.shifts.map(shift => {
                        console.log('ğŸ“ Erstelle Schicht-HTML fÃ¼r:', shift);
                        return `
                        <label class="flex items-start space-x-3 p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition-colors">
                            <input type="checkbox" value="${shift.id}" class="shift-checkbox mt-1 text-fire-500 focus:ring-fire-500" onchange="window.eventsManager.toggleShift('${shift.id}')">
                            <div class="flex-1">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="font-medium text-gray-800">${shift.name || 'Unnamed Shift'}</p>
                                        <p class="text-sm text-gray-600">${shift.date || 'TBD'} â€¢ ${shift.time || 'TBD'}</p>
                                        <p class="text-xs text-gray-500">${shift.description || 'Keine Beschreibung'}</p>
                                    </div>
                                    <span class="text-xs bg-fire-100 text-fire-800 px-2 py-1 rounded-full">
                                        ${shift.needed || 1} benÃ¶tigt
                                    </span>
                                </div>
                            </div>
                        </label>
                    `}).join('');
                } else if (event.participantRegistration) {
                    console.log('âœ… Teilnehmer-Anmeldung verfÃ¼gbar');
                    shiftSelection.classList.add('hidden');
                    participantsSection.classList.remove('hidden');
                } else {
                    console.log('âš ï¸ Weder Schichten noch Teilnehmer-Anmeldung verfÃ¼gbar');
                    shiftSelection.classList.add('hidden');
                    participantsSection.classList.add('hidden');
                }

                // Make eventsManager globally accessible for checkbox events
                window.eventsManager = this;
            }

            toggleShift(shiftId) {
                const index = this.selectedShifts.indexOf(shiftId);
                if (index > -1) {
                    this.selectedShifts.splice(index, 1);
                } else {
                    this.selectedShifts.push(shiftId);
                }
            }

            sendRegistrationEmail() {
                const event = this.selectedEvent;
                if (!event) return;

                // Get form data
                const name = document.getElementById('reg-name').value.trim();
                const email = document.getElementById('reg-email').value.trim();
                const phone = document.getElementById('reg-phone').value.trim();
                const notes = document.getElementById('reg-notes').value.trim();

                // Validation
                if (!name || !email) {
                    alert('Bitte fÃ¼llen Sie mindestens Name und E-Mail aus.');
                    return;
                }

                // Build email content
                let subject, body;

                if (event.shifts && event.shifts.length > 0 && this.selectedShifts.length > 0) {
                    // Helper registration with shifts
                    subject = `Helfer-Anmeldung: ${event.title}`;
                    
                    const selectedShiftDetails = event.shifts
                        .filter(shift => this.selectedShifts.includes(shift.id))
                        .map(shift => `â€¢ ${shift.name} (${shift.date}, ${shift.time}) - ${shift.description}`)
                        .join('\n');

                    body = `Hallo ${event.organizer},

hiermit melde ich mich als Helfer fÃ¼r folgende Schichten an:

VERANSTALTUNG: ${event.title}
DATUM: ${this.formatDate(event.startDate)}
ORT: ${event.location}

GEWÃ„HLTE SCHICHTEN:
${selectedShiftDetails}

MEINE KONTAKTDATEN:
Name: ${name}
E-Mail: ${email}
${phone ? `Telefon: ${phone}` : ''}

${notes ? `BEMERKUNGEN:\n${notes}` : ''}

Vielen Dank fÃ¼r die Organisation!

Mit freundlichen GrÃ¼ssen
${name}`;

                } else if (event.participantRegistration) {
                    // Participant registration
                    const participants = document.getElementById('reg-participants').value || '1';
                    subject = `Anmeldung: ${event.title}`;
                    
                    body = `Hallo ${event.organizer},

hiermit melde ich mich fÃ¼r die Veranstaltung an:

VERANSTALTUNG: ${event.title}
DATUM: ${this.formatDate(event.startDate)}
ZEIT: ${this.formatTime(event.startDate)} - ${this.formatTime(event.endDate)}
ORT: ${event.location}
${event.cost && event.cost !== 'Kostenlos' ? `KOSTEN: ${event.cost}` : ''}

ANMELDUNG:
Name: ${name}
E-Mail: ${email}
${phone ? `Telefon: ${phone}` : ''}
${event.participantRegistration && participants !== '1' ? `Anzahl Personen: ${participants}` : ''}

${notes ? `BEMERKUNGEN:\n${notes}` : ''}

Vielen Dank fÃ¼r die Organisation!

Mit freundlichen GrÃ¼ssen
${name}`;

                } else {
                    // General registration
                    subject = `Anmeldung: ${event.title}`;
                    body = `Hallo ${event.organizer},

hiermit melde ich mich fÃ¼r die Veranstaltung an:

VERANSTALTUNG: ${event.title}
DATUM: ${this.formatDate(event.startDate)}

KONTAKTDATEN:
Name: ${name}
E-Mail: ${email}
${phone ? `Telefon: ${phone}` : ''}

${notes ? `BEMERKUNGEN:\n${notes}` : ''}

Mit freundlichen GrÃ¼ssen
${name}`;
                }

                // Create mailto link
                const mailtoLink = `mailto:${event.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                
                // Open email client
                window.location.href = mailtoLink;

                // Show success message
                setTimeout(() => {
                    alert('E-Mail-Client wurde geÃ¶ffnet. Bitte senden Sie die E-Mail ab.');
                }, 500);
            }

            closeModal() {
                document.getElementById('event-modal').classList.add('hidden');
                this.selectedEvent = null;
                this.selectedShifts = [];
                
                // Reset form
                document.getElementById('reg-name').value = '';
                document.getElementById('reg-email').value = '';
                document.getElementById('reg-phone').value = '';
                document.getElementById('reg-notes').value = '';
                
                // Uncheck all shift checkboxes
                document.querySelectorAll('.shift-checkbox').forEach(cb => cb.checked = false);
            }

            downloadEventICS() {
                if (!this.selectedEvent) return;
                const icsData = this.generateICS([this.selectedEvent]);
                this.downloadICS(icsData, `${this.selectedEvent.id}.ics`);
            }

            shareEvent() {
                if (!this.selectedEvent) return;
                
                const url = `${window.location.origin}${window.location.pathname}#event-${this.selectedEvent.id}`;
                const text = `${this.selectedEvent.title} - ${this.formatDate(this.selectedEvent.startDate)}`;
                
                if (navigator.share) {
                    navigator.share({
                        title: this.selectedEvent.title,
                        text: text,
                        url: url
                    });
                } else {
                    navigator.clipboard.writeText(`${text}\n${url}`).then(() => {
                        alert('Link wurde in die Zwischenablage kopiert!');
                    });
                }
            }

            generateICS(events) {
                const now = new Date();
                let ics = [
                    'BEGIN:VCALENDAR',
                    'VERSION:2.0',
                    'PRODID:-//Feuerwehrverein Raura Kaiseraugst//Vereinskalender//DE',
                    'CALSCALE:GREGORIAN',
                    'METHOD:PUBLISH',
                    'X-WR-CALNAME:Feuerwehrverein Raura Kaiseraugst',
                    'X-WR-CALDESC:Termine und Veranstaltungen des Feuerwehrvereins Raura Kaiseraugst',
                    'X-WR-TIMEZONE:Europe/Zurich'
                ];

                events.forEach(event => {
                    const uid = `${event.id}@feuerwehrverein-raura.ch`;
                    const dtstart = this.formatDateForICS(event.startDate);
                    const dtend = this.formatDateForICS(event.endDate);
                    const dtstamp = this.formatDateForICS(now);
                    const description = event.description.replace(/\n/g, '\\n');

                    ics.push(
                        'BEGIN:VEVENT',
                        `UID:${uid}`,
                        `DTSTAMP:${dtstamp}`,
                        `DTSTART:${dtstart}`,
                        `DTEND:${dtend}`,
                        `SUMMARY:${event.title}`,
                        `DESCRIPTION:${description}`,
                        `LOCATION:${event.location}`,
                        `ORGANIZER;CN=${event.organizer}:mailto:${event.email}`,
                        `CATEGORIES:${event.category}`,
                        'STATUS:CONFIRMED',
                        'END:VEVENT'
                    );
                });

                ics.push('END:VCALENDAR');
                return ics.join('\r\n');
            }

            downloadICS(icsData, filename) {
                const blob = new Blob([icsData], { type: 'text/calendar;charset=utf-8' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }

            parseMarkdownToHTML(text) {
                return text
                    .replace(/\n\n/g, '</p><p class="mb-3">')
                    .replace(/\n- /g, '</p><li class="ml-4">â€¢ ')
                    .replace(/\n/g, '<br>')
                    .replace(/^(.+)$/gm, '<p class="mb-3">$1</p>')
                    .replace(/(<li.*<\/li>)/gs, '<ul class="mb-3 list-none">$1</ul>')
                    .replace(/<p class="mb-3"><\/p>/g, '');
            }

            truncateText(text, maxLength) {
                const plainText = text.replace(/\n/g, ' ').trim();
                if (plainText.length <= maxLength) return plainText;
                return plainText.substring(0, maxLength) + '...';
            }

            formatDate(date) {
                return new Intl.DateTimeFormat('de-DE', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    weekday: 'long'
                }).format(date);
            }

            formatTime(date) {
                return new Intl.DateTimeFormat('de-DE', {
                    hour: '2-digit',
                    minute: '2-digit'
                }).format(date);
            }

            formatDateForICS(date) {
                return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
            }
        }

        // Initialize events manager when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new EventsManager();
        });
    </script>
</body>
</html>
