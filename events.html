<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Veranstaltungen des Feuerwehrvereins Raura Kaiseraugst">
    <title>Veranstaltungen - Feuerwehrverein Raura Kaiseraugst</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        fire: {
                            50: '#fef2f2',
                            100: '#fee2e2',
                            200: '#fecaca',
                            300: '#fca5a5',
                            400: '#f87171',
                            500: '#ef4444',
                            600: '#dc2626',
                            700: '#b91c1c',
                            800: '#991b1b',
                            900: '#7f1d1d',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .animate-slide-in {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from {
                transform: translateY(-10px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg sticky top-0 z-40">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center h-20">
                <a href="index.html" class="flex items-center space-x-3">
                    <img src="images/logo.png" alt="FWV Raura Logo" class="h-12 w-12">
                    <div>
                        <div class="text-xl font-bold text-gray-800">FWV Raura</div>
                        <div class="text-xs text-gray-600">Kaiseraugst</div>
                    </div>
                </a>
                <div class="hidden md:flex space-x-8">
                    <a href="index.html" class="text-gray-700 hover:text-fire-500 transition">Home</a>
                    <a href="events.html" class="text-fire-500 font-semibold">Veranstaltungen</a>
                    <a href="calendar.html" class="text-gray-700 hover:text-fire-500 transition">Kalender</a>
                    <a href="chilbi.html" class="text-gray-700 hover:text-fire-500 transition">Chilbi</a>
                    <a href="contact.html" class="text-gray-700 hover:text-fire-500 transition">Kontakt</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="bg-gradient-to-r from-fire-500 to-fire-600 text-white py-16">
        <div class="container mx-auto px-4 text-center">
            <h1 class="text-4xl md:text-5xl font-bold mb-4">Unsere Veranstaltungen</h1>
            <p class="text-xl opacity-90">Tradition • Kameradschaft • Gemeinschaft</p>
        </div>
    </section>

    <!-- Filter & Search Section -->
    <section class="bg-white shadow-md py-6 sticky top-20 z-30">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row gap-4">
                <!-- Search -->
                <div class="flex-1">
                    <input 
                        type="text" 
                        id="search-input"
                        placeholder="Veranstaltung suchen..." 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-fire-500">
                </div>
                
                <!-- Category Filter -->
                <select 
                    id="category-filter"
                    class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-fire-500">
                    <option value="">Alle Kategorien</option>
                    <option value="Hauptveranstaltung">Hauptveranstaltung</option>
                    <option value="Gesellschaftsanlass">Gesellschaftsanlass</option>
                    <option value="Ausflug">Ausflug</option>
                    <option value="Vereinsintern">Vereinsintern</option>
                </select>
                
                <!-- Time Filter -->
                <select 
                    id="time-filter"
                    class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-fire-500">
                    <option value="all">Alle Events</option>
                    <option value="upcoming">Kommende Events</option>
                    <option value="ongoing">Laufende Events</option>
                    <option value="past">Vergangene Events</option>
                </select>
                
                <!-- View Toggle -->
                <div class="flex gap-2">
                    <button 
                        id="view-list"
                        class="px-4 py-2 bg-fire-500 text-white rounded-lg hover:bg-fire-600 transition">
                        📋 Liste
                    </button>
                    <button 
                        id="view-grid"
                        class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">
                        ⊞ Karten
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Events Container -->
    <section class="py-8">
        <div class="container mx-auto px-4">
            <div id="events-container" class="space-y-6">
                <!-- Events will be loaded here -->
            </div>
            
            <div id="no-events" class="hidden text-center py-12">
                <p class="text-gray-500 text-lg">Keine Veranstaltungen gefunden.</p>
            </div>
        </div>
    </section>

    <!-- Event Detail Modal -->
    <div id="event-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="relative">
                <!-- Modal Header -->
                <div id="modal-header" class="bg-gradient-to-r from-fire-500 to-fire-600 text-white p-6 rounded-t-lg">
                    <button id="close-modal" class="absolute top-4 right-4 text-white hover:text-fire-200 text-2xl">×</button>
                    <h2 id="modal-title" class="text-2xl font-bold mb-2"></h2>
                    <div id="modal-meta" class="flex flex-wrap gap-4 text-fire-100 text-sm"></div>
                </div>
                
                <!-- Modal Content -->
                <div class="p-6">
                    <div id="modal-content" class="prose max-w-none">
                        <!-- Event details will be loaded here -->
                    </div>
                    
                    <!-- Registration Section -->
                    <div id="registration-section" class="hidden mt-8 border-t pt-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">📧 Anmeldung</h3>
                        
                        <!-- Shift Selection -->
                        <div id="shift-selection" class="hidden mb-6">
                            <h4 class="font-semibold text-gray-700 mb-3">Verfügbare Schichten:</h4>
                            <div id="shifts-container" class="space-y-2">
                                <!-- Shifts will be populated by JavaScript -->
                            </div>
                        </div>

                        <!-- Personal Information -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Name *</label>
                                <input type="text" id="reg-name" placeholder="Ihr Name" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-fire-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">E-Mail</label>
                                <input type="email" id="reg-email" placeholder="ihre.email@beispiel.ch" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-fire-500">
                            </div>
                        </div>

                        <div id="participant-section" class="hidden mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Anzahl Personen</label>
                            <select id="reg-participants" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-fire-500">
                                <option value="1">1 Person</option>
                                <option value="2">2 Personen</option>
                                <option value="3">3 Personen</option>
                                <option value="4">4 Personen</option>
                                <option value="5">5+ Personen</option>
                            </select>
                        </div>

                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Bemerkungen</label>
                            <textarea id="reg-notes" rows="3" placeholder="Zusätzliche Informationen..." class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-fire-500"></textarea>
                        </div>

                        <div class="bg-gray-50 p-4 rounded-lg mb-4">
                            <p class="text-sm text-gray-600">
                                Nach dem Klick auf "Anmeldung senden" wird Ihr E-Mail-Programm geöffnet 
                                mit einem vorausgefüllten E-Mail-Entwurf.
                            </p>
                        </div>

                        <div class="flex gap-3">
                            <button id="send-registration" class="flex-1 bg-fire-500 text-white px-6 py-3 rounded-lg hover:bg-fire-600 transition font-semibold">
                                📧 Anmeldung senden
                            </button>
                            <button id="cancel-registration" class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                                Abbrechen
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loading" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-40">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-fire-500 mx-auto mb-4"></div>
            <p class="text-gray-600">Lade Veranstaltungen...</p>
        </div>
    </div>

    <script>
        class EventsManager {
            constructor() {
                this.events = [];
                this.filteredEvents = [];
                this.currentFilter = 'all';
                this.currentCategory = '';
                this.searchQuery = '';
                this.viewMode = 'list';
                this.selectedEvent = null;
                this.selectedShifts = [];
                
                this.init();
            }

            async init() {
                console.log('🔄 Initialisiere Event-System...');
                await this.loadEvents();
                this.setupEventListeners();
                this.filterEvents();
                this.renderEvents();
                document.getElementById('loading').classList.add('hidden');
            }

            async loadEvents() {
                try {
                    console.log('📂 Lade Events aus Markdown-Dateien...');
                    this.events = await this.loadEventsFromMarkdown();
                    console.log(`✅ ${this.events.length} Events erfolgreich geladen:`, 
                        this.events.map(e => `${e.title} (${e.id})`));
                } catch (error) {
                    console.error('❌ Fehler beim Laden der Veranstaltungen:', error);
                    this.events = await this.getFallbackEvents();
                }
            }

            async loadEventsFromMarkdown() {
                // Liste aller Event-Dateien - hier alle Event-MD-Dateien hinzufügen
                const eventFiles = [
                    'events/chilbi-2025.md',
                    'events/grillplausch-sommer-2025.md',
                    'events/vereinsausflug-herbst-2025.md',
                    // Weitere Event-Dateien hier hinzufügen, wenn neue Events erstellt werden
                ];

                const promises = eventFiles.map(async (file) => {
                    try {
                        console.log(`📄 Lade: ${file}`);
                        const response = await fetch(file);
                        
                        if (!response.ok) {
                            console.warn(`⚠️ ${file}: HTTP ${response.status}`);
                            return null;
                        }
                        
                        const content = await response.text();
                        
                        if (!content.trim()) {
                            console.warn(`⚠️ ${file}: Datei ist leer`);
                            return null;
                        }
                        
                        const event = this.parseMarkdownEvent(content, file);
                        
                        if (event) {
                            console.log(`✅ Parsed: ${event.title}`);
                            
                            // Prüfe ob es zusätzliche Dateien gibt (Anmeldungen oder Schichtpläne)
                            await this.loadAdditionalEventData(event);
                            
                            return event;
                        }
                        
                    } catch (error) {
                        console.error(`❌ Fehler beim Laden von ${file}:`, error);
                        return null;
                    }
                });

                const results = await Promise.allSettled(promises);
                return results
                    .filter(result => result.status === 'fulfilled' && result.value !== null)
                    .map(result => result.value)
                    .sort((a, b) => a.startDate - b.startDate);
            }

            async loadAdditionalEventData(event) {
                // Lade Anmeldungen, falls vorhanden
                if (event.registrationRequired && event.participantRegistration) {
                    const registrationsFile = `events/${event.id}-registrations.md`;
                    try {
                        const response = await fetch(registrationsFile);
                        if (response.ok) {
                            const content = await response.text();
                            event.registrationsData = this.parseRegistrationsMarkdown(content);
                            console.log(`📋 Anmeldungen geladen für ${event.title}: ${event.registrationsData.participants?.length || 0} Teilnehmer`);
                        }
                    } catch (error) {
                        console.log(`ℹ️ Keine Anmeldedatei für ${event.title} gefunden`);
                    }
                }
                
                // Lade Schichtpläne, falls vorhanden
                if (event.shifts && event.shifts.length > 0) {
                    const assignmentsFile = `events/${event.id}-assignments.md`;
                    try {
                        const response = await fetch(assignmentsFile);
                        if (response.ok) {
                            const content = await response.text();
                            event.assignmentsData = this.parseAssignmentsMarkdown(content);
                            console.log(`👷 Schichtplan geladen für ${event.title}`);
                        }
                    } catch (error) {
                        console.log(`ℹ️ Kein Schichtplan für ${event.title} gefunden`);
                    }
                }
            }

            parseRegistrationsMarkdown(content) {
                // Parse Anmeldungen aus Markdown
                const data = {
                    participants: [],
                    totalCount: 0,
                    lastUpdate: null
                };
                
                // Extrahiere Teilnehmerliste
                const participantsMatch = content.match(/## Teilnehmer.*?\n([\s\S]*?)(?:\n##|\n---|$)/);
                if (participantsMatch) {
                    const lines = participantsMatch[1].trim().split('\n');
                    lines.forEach(line => {
                        const match = line.match(/^[-*]\s*(.+?)(?:\s*\((\d+)\s*Person.*?\))?$/);
                        if (match) {
                            data.participants.push({
                                name: match[1].trim(),
                                count: parseInt(match[2] || '1')
                            });
                        }
                    });
                }
                
                // Berechne Gesamtzahl
                data.totalCount = data.participants.reduce((sum, p) => sum + p.count, 0);
                
                // Extrahiere Aktualisierungsdatum
                const updateMatch = content.match(/\*\*Stand:\*\*\s*(.+)/);
                if (updateMatch) {
                    data.lastUpdate = updateMatch[1];
                }
                
                return data;
            }

            parseAssignmentsMarkdown(content) {
                // Parse Schichtplan aus Markdown
                const data = {
                    assignments: {},
                    statistics: {},
                    lastUpdate: null
                };
                
                // Extrahiere Schichtzuteilungen
                const shiftSections = content.split(/^##\s+/m);
                shiftSections.forEach(section => {
                    const lines = section.trim().split('\n');
                    if (lines.length === 0) return;
                    
                    // Finde Schicht-IDs
                    lines.forEach(line => {
                        const shiftMatch = line.match(/^###\s*([^\s]+)\s*\(/);
                        if (shiftMatch) {
                            const shiftId = shiftMatch[1];
                            data.assignments[shiftId] = [];
                            
                            // Sammle die nachfolgenden Namen
                            const idx = lines.indexOf(line);
                            for (let i = idx + 1; i < lines.length; i++) {
                                const nameMatch = lines[i].match(/^[-*]\s*(.+)$/);
                                if (nameMatch && !nameMatch[1].includes('[OFFEN')) {
                                    data.assignments[shiftId].push(nameMatch[1].trim());
                                } else if (!lines[i].startsWith('-') && !lines[i].startsWith('*')) {
                                    break;
                                }
                            }
                        }
                    });
                });
                
                // Extrahiere Statistiken
                const statsMatch = content.match(/## Statistik([\s\S]*?)(?:\n##|$)/);
                if (statsMatch) {
                    const statsLines = statsMatch[1].trim().split('\n');
                    statsLines.forEach(line => {
                        const match = line.match(/\*\*(.+?):\*\*\s*(.+)/);
                        if (match) {
                            data.statistics[match[1]] = match[2];
                        }
                    });
                }
                
                // Extrahiere Aktualisierungsdatum
                const updateMatch = content.match(/\*\*Generiert:\*\*\s*(.+)/);
                if (updateMatch) {
                    data.lastUpdate = updateMatch[1];
                }
                
                return data;
            }

            parseMarkdownEvent(content, filename = '') {
                try {
                    // Frontmatter pattern matching
                    const frontmatterMatch = content.match(/^---\r?\n([\s\S]*?)\r?\n---\r?\n([\s\S]*)$/);
                    if (!frontmatterMatch) {
                        console.warn(`⚠️ ${filename}: Kein gültiges Frontmatter gefunden`);
                        return null;
                    }

                    const [, frontmatterStr, markdownContent] = frontmatterMatch;
                    const frontmatter = this.parseFrontmatter(frontmatterStr);
                    
                    // Konvertiere Datums-Strings zu Date-Objekten
                    const event = {
                        ...frontmatter,
                        description: markdownContent.trim(),
                        startDate: new Date(frontmatter.startDate),
                        endDate: new Date(frontmatter.endDate),
                        registrationDeadline: frontmatter.registrationDeadline ? 
                            new Date(frontmatter.registrationDeadline) : null
                    };

                    // Validierung
                    if (!event.id || !event.title || !event.startDate || !event.endDate) {
                        console.warn(`⚠️ ${filename}: Pflichtfelder fehlen`);
                        return null;
                    }

                    return event;
                    
                } catch (error) {
                    console.error(`❌ Fehler beim Parsen von ${filename}:`, error);
                    return null;
                }
            }

            parseFrontmatter(str) {
                const frontmatter = {};
                const lines = str.split('\n');
                
                for (const line of lines) {
                    const colonIndex = line.indexOf(':');
                    if (colonIndex === -1) continue;
                    
                    const key = line.substring(0, colonIndex).trim();
                    let value = line.substring(colonIndex + 1).trim();
                    
                    // Handle arrays
                    if (value.startsWith('[') && value.endsWith(']')) {
                        value = value.slice(1, -1).split(',').map(v => v.trim());
                    }
                    // Handle booleans
                    else if (value === 'true') value = true;
                    else if (value === 'false') value = false;
                    // Handle numbers
                    else if (!isNaN(value) && value !== '') {
                        value = Number(value);
                    }
                    
                    frontmatter[key] = value;
                }
                
                // Handle shifts if present
                if (str.includes('shifts:')) {
                    const shiftsMatch = str.match(/shifts:\s*\n((?:\s+-[\s\S]*?(?=\n\w|\n$))+)/);
                    if (shiftsMatch) {
                        frontmatter.shifts = this.parseShifts(shiftsMatch[1]);
                    }
                }
                
                return frontmatter;
            }

            parseShifts(shiftsStr) {
                const shifts = [];
                const shiftBlocks = shiftsStr.split(/\n\s*-\s+(?=id:)/).filter(Boolean);
                
                for (const block of shiftBlocks) {
                    const shift = {};
                    const lines = block.split('\n');
                    
                    for (const line of lines) {
                        const match = line.match(/^\s*(\w+):\s*(.+)$/);
                        if (match) {
                            const [, key, value] = match;
                            shift[key] = isNaN(value) ? value : Number(value);
                        }
                    }
                    
                    if (shift.id) {
                        shifts.push(shift);
                    }
                }
                
                return shifts;
            }

            async getFallbackEvents() {
                // Fallback-Events falls keine Markdown-Dateien geladen werden können
                return [
                    {
                        id: 'chilbi-2025',
                        title: 'Chilbi 2025',
                        subtitle: 'Das grösste Fest im Jahr!',
                        startDate: new Date('2025-10-18T10:00:00'),
                        endDate: new Date('2025-10-19T18:00:00'),
                        location: 'Roten Schopf, Kaiseraugst',
                        organizer: 'Feuerwehrverein Raura',
                        email: 'chilbi@feuerwehrverein-raura.ch',
                        category: 'Hauptveranstaltung',
                        cost: 'Eintritt frei',
                        description: 'Die traditionelle Chilbi ist der Höhepunkt im Vereinsjahr...',
                        registrationRequired: true,
                        shifts: [
                            { id: 'aufbau', name: 'Aufbau', date: '2025-10-16', time: '17:00-20:00', needed: 5 },
                            { id: 'samstag-bar', name: 'Bar Samstag', date: '2025-10-18', time: '10:00-14:00', needed: 3 }
                        ]
                    }
                ];
            }

            setupEventListeners() {
                // Filter & Search
                document.getElementById('time-filter').addEventListener('change', (e) => {
                    this.currentFilter = e.target.value;
                    this.filterEvents();
                    this.renderEvents();
                });

                document.getElementById('category-filter').addEventListener('change', (e) => {
                    this.currentCategory = e.target.value;
                    this.filterEvents();
                    this.renderEvents();
                });

                document.getElementById('search-input').addEventListener('input', (e) => {
                    this.searchQuery = e.target.value.toLowerCase();
                    this.filterEvents();
                    this.renderEvents();
                });

                // View Mode Toggle
                document.getElementById('view-list').addEventListener('click', () => {
                    this.viewMode = 'list';
                    document.getElementById('view-list').classList.add('bg-fire-500', 'text-white');
                    document.getElementById('view-list').classList.remove('bg-gray-200', 'text-gray-700');
                    document.getElementById('view-grid').classList.remove('bg-fire-500', 'text-white');
                    document.getElementById('view-grid').classList.add('bg-gray-200', 'text-gray-700');
                    this.renderEvents();
                });

                document.getElementById('view-grid').addEventListener('click', () => {
                    this.viewMode = 'grid';
                    document.getElementById('view-grid').classList.add('bg-fire-500', 'text-white');
                    document.getElementById('view-grid').classList.remove('bg-gray-200', 'text-gray-700');
                    document.getElementById('view-list').classList.remove('bg-fire-500', 'text-white');
                    document.getElementById('view-list').classList.add('bg-gray-200', 'text-gray-700');
                    this.renderEvents();
                });

                // Modal Controls
                document.getElementById('close-modal').addEventListener('click', () => this.closeModal());
                document.getElementById('event-modal').addEventListener('click', (e) => {
                    if (e.target === document.getElementById('event-modal')) {
                        this.closeModal();
                    }
                });
                
                document.getElementById('send-registration').addEventListener('click', () => this.sendRegistration());
                document.getElementById('cancel-registration').addEventListener('click', () => this.closeModal());
            }

            filterEvents() {
                let filtered = [...this.events];
                const now = new Date();

                // Time filter
                if (this.currentFilter === 'upcoming') {
                    filtered = filtered.filter(event => event.startDate > now);
                } else if (this.currentFilter === 'ongoing') {
                    filtered = filtered.filter(event => 
                        event.startDate <= now && event.endDate >= now
                    );
                } else if (this.currentFilter === 'past') {
                    filtered = filtered.filter(event => event.endDate < now);
                }

                // Category filter
                if (this.currentCategory) {
                    filtered = filtered.filter(event => event.category === this.currentCategory);
                }

                // Search filter
                if (this.searchQuery) {
                    filtered = filtered.filter(event => 
                        event.title.toLowerCase().includes(this.searchQuery) ||
                        event.description.toLowerCase().includes(this.searchQuery) ||
                        event.location.toLowerCase().includes(this.searchQuery) ||
                        event.organizer.toLowerCase().includes(this.searchQuery) ||
                        (event.tags && event.tags.some(tag => tag.toLowerCase().includes(this.searchQuery)))
                    );
                }

                // Sort by date
                filtered.sort((a, b) => {
                    if (this.currentFilter === 'past') {
                        return b.startDate - a.startDate;
                    }
                    return a.startDate - b.startDate;
                });

                this.filteredEvents = filtered;
            }

            renderEvents() {
                const container = document.getElementById('events-container');
                const noEventsMsg = document.getElementById('no-events');

                if (this.filteredEvents.length === 0) {
                    container.innerHTML = '';
                    noEventsMsg.classList.remove('hidden');
                    return;
                }

                noEventsMsg.classList.add('hidden');

                if (this.viewMode === 'list') {
                    container.className = 'space-y-6';
                    container.innerHTML = this.filteredEvents.map(event => this.createEventListItem(event)).join('');
                } else {
                    container.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
                    container.innerHTML = this.filteredEvents.map(event => this.createEventGridItem(event)).join('');
                }

                // Add click listeners
                container.querySelectorAll('[data-event-id]').forEach(el => {
                    el.addEventListener('click', (e) => {
                        const eventId = e.currentTarget.dataset.eventId;
                        this.showEventModal(eventId);
                    });
                });
